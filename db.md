## 知识

#### MVVC

多版本并发控制。在rr基础上，避免幻读。

事务日志：对内存副本的修改，追加写。

binlog：用于恢复、复制。比如主从。

redolog：物理层面修改。事务所需版本。

undolog：撤回redolog，用于回溯。

MVCC实现：数据行记录保存了创建版本号和删除版本号

#### b+树

#### 事务

#### 锁

原理。记录锁，间隙锁，next-key锁。唯一索引时next-key降级。next-key锁=记录锁加间隙锁。

## [MySQL实战45讲](https://time.geekbang.org/column/intro/139)

#### 1 SQL执行

连接器，查询缓存，分析器，优化器，执行器

#### 2 日志系统

先写日志再集中写入磁盘。InnoDB redolog，server层binlog。区别：特有和均可用，物理日志和原始日志，redo循环写，binlog追加写入。

更新语句的执行过程：先写redolog，再binlog，再redo提交。为了保持两份日志逻辑一致。

binlog写前崩溃回滚。写后崩溃提交。保证事务正常完成。

redolog和binlog同时存在的原因

内容：bin逻辑，数据改变信息，redo物理，记录所有innodb表数据变化。时间：bin在commit完后的sql，redo在事务发起之后的sql。使用方式：bin追加写，redo循环。作用：bin恢复数据，主从复制，redo宕机或故障。

#### 3 事务隔离

innodb支持事务。事务间的隔离级别。实现：回滚记录。同时保留多版本。要避免长事务。事务的启动方式

隔离级别：未提交读ru、提交读rc、可重复读rr、串行化s

acid 脏读不可重复读幻读。Atomic（原子性）, Consistency（一致性）, Isolation（隔离性）, Durability（持久性）。

#### 4 索引

常见：哈希表、有序数组、搜索树。哈希表适合等值查询，有序数组适合静态数据。

n叉搜索树：数据块大小。普通索引和主键索引

解决长事务技巧

5 覆盖索引：根据a值查询b值，b值在a值索引上

前缀索引：用索引开头的相符性做查询

索引下推：对索引中包含的b做判断，提前过滤，避免回表

#### 6 全局锁和表锁

全局锁：处于只读，阻塞其他。用于逻辑备份，会影响性能。innodb支持一致性读，便于备份。备份时不应使用setreadonly设置只读。

表级锁：锁表和MDL锁元数据。添加列要小心因阻塞与重试导致的死机。

#### 7 行锁

用于并发。innodb支持。用到时获得，提交了才会释放。易冲突锁要尽可能向后放，减少占用。

死锁：发现后主动回滚策略和等待超时策略。一般用主动，热点行可能带来因查找死锁带来的空转。1临时关死锁方案，一定风险，可能超时，适合确定没死锁。2并发度控制方案，客户端限，或考虑在中间件或mysqlsever层实现排队。3将热点行分为多个逻辑行。

同步不同时刻来ddl的外部表现

#### 8 事务可重复读视图细节

获得行锁前等待其他事务释放，得到锁时，读到的内容是什么？

一致性读：innodb行数据有多个版本。一致性视图时第一条快照读语句时创建的。事务有递增id。事务在一致性视图中只认启动前或自己生成的版本，否则用undolog回溯。每个事务保存着当前未提交的事务id，若版本的事务id在其中说明是启动后生成，不认，若不在其中说明其是启动前生成，认。

更新和加锁查询是当前读，普通查询是一致性读。两阶段锁。当前读：读取已完成的最新版本。

rr级别事务共用一个视图，rc级别每个语句计算新视图。

表结构不支持“可重复读”是因为没有行数据，没有版本号，只能当前读。8.0已经将表结构放入字典，也许以后会支持。

事务中删改无效问题。

原因：当前读和一致性读冲突，提交前被其他事务截胡。解决方式：乐观锁退出

## [MySQL王者晋级之路](https://book.douban.com/subject/30172800/)

#### 6 索引

642 icp: 引擎层使用索引过滤 mrr：普通索引找出的主键集合经过排序后再回表 bka join过程中先排序后在第二个表里找

唯一索引：不允许重复，允许空。覆盖索引：部分聚集索引。

#### 7 事务

一致性：处理前后都满足业务规则约束。

#### 8 锁

next-key lock：行锁间隙锁组合

821 行锁是加到索引项上的，若字段没有索引则全部锁

间隙锁：锁定数据范围，避免幻读。
